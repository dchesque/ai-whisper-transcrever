{% extends "base.html" %}

{% block title %}Dashboard - TranscreveAI{% endblock %}

{% block extra_css %}
<style>
    .dashboard {
        padding: var(--space-6) 0;
    }
    
    .dashboard-header {
        margin-bottom: var(--space-8);
    }
    
    .dashboard-welcome {
        background: linear-gradient(to right, var(--color-primary-600), var(--color-primary-700));
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        color: white;
        margin-bottom: var(--space-8);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-welcome::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle at center, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
        transform: translate(30%, -30%);
        z-index: 1;
    }
    
    .dashboard-welcome__content {
        position: relative;
        z-index: 2;
        max-width: 600px;
    }
    
    .dashboard-welcome__title {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }
    
    .dashboard-welcome__subtitle {
        opacity: 0.9;
        margin-bottom: var(--space-4);
    }
    
    .dashboard-welcome__actions {
        display: flex;
        gap: var(--space-3);
    }
    
    .btn--light {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn--light:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }
    
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }
    
    .stat-card {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
        border: 1px solid var(--color-border);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }
    
    .stat-card__value {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-2);
    }
    
    .stat-card__label {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .dashboard-section {
        margin-bottom: var(--space-12);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);
    }
    
    .section-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
    }
    
    .section-subtitle {
        color: var(--color-text-secondary);
        font-size: var(--font-size-md);
    }
    
    .empty-state {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-12);
        text-align: center;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border);
    }
    
    .empty-icon-container {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-6);
    }
    
    .empty-icon {
        width: 80px;
        height: 80px;
        color: var(--color-primary-600);
        position: relative;
        z-index: 2;
    }
    
    .pulse-animation {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background-color: var(--color-primary-100);
        border-radius: 50%;
        z-index: 1;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.6; }
        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.3; }
        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.6; }
    }
    
    .empty-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-3);
        color: var(--color-text-primary);
    }
    
    .empty-description {
        color: var(--color-text-secondary);
        margin-bottom: var(--space-6);
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .empty-steps {
        display: flex;
        flex-direction: column;
        max-width: 500px;
        margin: var(--space-8) auto 0;
        gap: var(--space-4);
    }
    
    .empty-step {
        display: flex;
        gap: var(--space-4);
        text-align: left;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        background-color: var(--color-primary-100);
        color: var(--color-primary-700);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-weight-bold);
    }
    
    .step-content {
        flex: 1;
    }
    
    .step-title {
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
    }
    
    .step-description {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
    }
    
    .transcriptions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--space-6);
    }
    
    .transcription-card {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
        border: 1px solid var(--color-border);
    }
    
    .transcription-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }
    
    .transcription-card__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }
    
    .transcription-card__title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
    }
    
    .transcription-card__actions {
        display: flex;
        gap: var(--space-2);
    }
    
    .action-button {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        color: var(--color-text-secondary);
        font-size: var(--font-size-md);
    }
    
    .transcription-card__meta {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
    }
    
    .tag {
        background-color: var(--color-surface);
        border-radius: var(--radius-full);
        padding: var(--space-2) var(--space-4);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
    }
    
    .tag--category {
        background-color: var(--color-primary-100);
        color: var(--color-primary-700);
    }
    
    .transcription-card__content {
        margin-top: var(--space-4);
    }
    
    .transcription-card__text {
        color: var(--color-text-secondary);
        font-size: var(--font-size-md);
    }
    
    /* Estilos para o modal */
    .modal {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: var(--space-4);
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        animation: modal-slide-up 0.3s ease-out;
    }
    
    @keyframes modal-slide-up {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
    }
    
    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-text-secondary);
        transition: color var(--transition-normal);
    }
    
    .modal-close:hover {
        color: var(--color-text-primary);
    }
    
    .modal-tabs {
        display: flex;
        padding: 0 var(--space-6);
        border-bottom: 1px solid var(--color-border);
    }
    
    .modal-tab {
        padding: var(--space-4) var(--space-3);
        border-bottom: 2px solid transparent;
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        color: var(--color-text-secondary);
        transition: all var(--transition-normal);
    }
    
    .modal-tab:hover {
        color: var(--color-text-primary);
    }
    
    .modal-tab.active {
        color: var(--color-primary-600);
        border-bottom-color: var(--color-primary-600);
    }
    
    .modal-body {
        padding: var(--space-6);
        overflow-y: auto;
        flex: 1;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .modal-text {
        font-family: var(--font-family-mono);
        white-space: pre-wrap;
        padding: var(--space-4);
        background-color: var(--color-surface-muted);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        font-size: var(--font-size-sm);
        line-height: 1.6;
        max-height: 50vh;
        overflow-y: auto;
        margin: 0;
    }
    
    .modal-footer {
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
    }

    .btn--outline {
        background-color: transparent;
        border: 1px solid var(--color-primary-600);
        color: var(--color-primary-600);
    }
    
    .btn--outline:hover {
        background-color: var(--color-primary-50);
    }
    
    .btn--danger {
        background-color: var(--color-danger);
        color: white;
    }
    
    .btn--danger:hover {
        background-color: var(--color-danger-hover);
    }
    
    /* Formulário para edição */
    .form-group {
        margin-bottom: var(--space-6);
    }
    
    .form-label {
        display: block;
        margin-bottom: var(--space-2);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
    }
    
    .form-input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        transition: all var(--transition-normal);
    }
    
    .form-input:focus {
        border-color: var(--color-primary-600);
        box-shadow: 0 0 0 3px var(--color-primary-100);
        outline: none;
    }
    
    .update-status {
        padding: var(--space-3);
        border-radius: var(--radius-md);
        margin-top: var(--space-4);
        margin-bottom: var(--space-4);
        display: none;
    }
    
    .update-status.success {
        display: block;
        background-color: var(--color-success-50);
        border: 1px solid var(--color-success);
        color: var(--color-success-dark);
    }
    
    .update-status.error {
        display: block;
        background-color: var(--color-danger-50);
        border: 1px solid var(--color-danger);
        color: var(--color-danger-dark);
    }
    
    @media (max-width: 768px) {
        .dashboard-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="container">
        <div class="dashboard-welcome">
            <div class="dashboard-welcome__content">
                <h1 class="dashboard-welcome__title">Olá, {{ user.email.split('@')[0] }}</h1>
                <p class="dashboard-welcome__subtitle">Bem-vindo ao seu Dashboard. Aqui você pode gerenciar todas as suas transcrições.</p>
                <div class="dashboard-welcome__actions">
                    <a href="{{ url_for('index') }}" class="btn btn--primary">Nova Transcrição</a>
                    <a href="{{ url_for('index') }}#profile" class="btn btn--light">Meu Perfil</a>
                </div>
            </div>
        </div>
        
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-card__value">{{ transcriptions|length if transcriptions else 0 }}</div>
                <div class="stat-card__label">Transcrições totais</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card__value">{{ pdfs|length if pdfs else 0 }}</div>
                <div class="stat-card__label">Arquivos PDF</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card__value">{{ "0" }}</div>
                <div class="stat-card__label">Em processamento</div>
            </div>
        </div>
        
        <!-- Seção principal com transcrições -->
        {% if transcriptions %}
        <div class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Suas Transcrições</h2>
                    <p class="section-subtitle">Gerencie todas as suas transcrições em um só lugar</p>
                </div>
                <div class="section-actions">
                    <a href="{{ url_for('index') }}" class="btn btn--outline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nova
                    </a>
                </div>
            </div>
            
            <div class="transcriptions-grid">
                {% for transcription in transcriptions %}
                <div class="transcription-card">
                    <div class="transcription-card__header">
                        <h3 class="transcription-card__title">{{ transcription.title or transcription.original_filename }}</h3>
                        <div class="transcription-card__actions">
                            <button class="action-button" data-id="{{ transcription.id }}" 
                                    data-title="{{ transcription.title or transcription.original_filename }}"
                                    data-text="{{ transcription.transcription_text }}"
                                    data-category="{{ transcription.category or '' }}"
                                    onclick="viewTranscriptionFromData(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <button class="action-button" onclick="downloadTranscription('{{ transcription.id }}', '{{ transcription.title or transcription.original_filename }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </button>
                            <button class="action-button" onclick="confirmDelete('{{ transcription.id }}', '{{ transcription.title or transcription.original_filename }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="transcription-card__meta">
                        {% if transcription.category %}
                        <span class="tag tag--category">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            {{ transcription.category }}
                        </span>
                        {% endif %}
                        
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            {{ transcription.created_at.split('T')[0].replace('-', '/').replace('-', '/') }}
                        </span>
                        
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            {{ transcription.file_type }}
                        </span>
                        
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                            </svg>
                            {{ transcription.language }}
                        </span>
                        
                        {% if transcription.duration %}
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {{ (transcription.duration / 60)|round(1) }} min
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="transcription-card__content">
                        <p class="transcription-card__text">
                            {{ transcription.transcription_text[:150] }}{% if transcription.transcription_text|length > 150 %}...{% endif %}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif pdfs %}
        <div class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">PDFs Locais (Legado)</h2>
                    <p class="section-subtitle">Arquivos PDF armazenados localmente</p>
                </div>
            </div>
            
            <div class="transcriptions-grid">
                {% for pdf in pdfs %}
                <div class="transcription-card">
                    <div class="transcription-card__header">
                        <h3 class="transcription-card__title">{{ pdf.filename }}</h3>
                        <div class="transcription-card__actions">
                            <a href="{{ url_for('download_pdf', filename=pdf.filename) }}" class="action-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </a>
                            <button class="action-button" onclick="confirmDeletePDF('{{ pdf.filename }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="transcription-card__meta">
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            {{ pdf.created_at }}
                        </span>
                        
                        <span class="tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            PDF
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon-container">
                <svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <div class="pulse-animation"></div>
            </div>
            <h2 class="empty-title">Nenhuma transcrição encontrada</h2>
            <p class="empty-description">Você ainda não possui transcrições. Faça sua primeira transcrição agora mesmo!</p>
            <a href="{{ url_for('index') }}" class="btn btn--primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nova Transcrição
            </a>
            <div class="empty-steps">
                <div class="empty-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 class="step-title">Envie seu arquivo</h3>
                        <p class="step-description">Carregue um arquivo de áudio/vídeo ou forneça uma URL</p>
                    </div>
                </div>
                <div class="empty-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 class="step-title">Aguarde o processamento</h3>
                        <p class="step-description">Nossa IA converterá o áudio em texto</p>
                    </div>
                </div>
                <div class="empty-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 class="step-title">Obtenha sua transcrição</h3>
                        <p class="step-description">Baixe o resultado em formato texto</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Visualização da Transcrição -->
<div id="transcription-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-transcription-title">Visualizar Transcrição</h2>
            <button class="modal-close" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-tabs">
            <button class="modal-tab active" data-tab="content">Conteúdo</button>
            <button class="modal-tab" data-tab="edit">Editar Detalhes</button>
            <button class="modal-tab" data-tab="categories">Categorias</button>
        </div>
        <div class="modal-body">
            <div class="tab-content active" id="tab-content">
                <pre id="transcription-text" class="modal-text"></pre>
            </div>
            <div class="tab-content" id="tab-edit">
                <form id="edit-form" class="edit-form">
                    <div class="form-group">
                        <label for="edit-title" class="form-label">Título</label>
                        <input type="text" id="edit-title" name="title" class="form-input" placeholder="Digite um título para a transcrição">
                    </div>
                    <div id="update-status" class="update-status"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn--primary">Salvar Alterações</button>
                    </div>
                </form>
            </div>
            <div class="tab-content" id="tab-categories">
                <div id="categories-container">
                    <div class="categories-loading">Carregando categorias...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn--outline" onclick="downloadCurrentText()">Baixar TXT</button>
            <button class="btn btn--primary" onclick="downloadTranscriptionPDF(currentTranscriptionId)">Baixar PDF</button>
            <button class="btn btn--secondary" onclick="closeModal()">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Confirmar Exclusão</h2>
            <button class="modal-close" onclick="closeDeleteModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="delete-message">Tem certeza que deseja excluir esta transcrição? Esta ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn--secondary" onclick="closeDeleteModal()">Cancelar</button>
            <button class="btn btn--danger" id="confirm-delete-btn">Excluir</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTranscriptionId = null;
    let currentTranscriptionText = '';
    let currentTranscriptionTitle = '';
    let currentTranscriptionCategory = '';
    let isPDF = false;
    
    // Função auxiliar para ler dados do elemento
    function viewTranscriptionFromData(button) {
        const id = button.getAttribute('data-id');
        const title = button.getAttribute('data-title');
        const text = button.getAttribute('data-text');
        const category = button.getAttribute('data-category');
        
        viewTranscription(id, title, text, category);
    }
    
    // Funções para o modal de transcrição
    function viewTranscription(id, title, text, category) {
        // Configurar variáveis globais
        currentTranscriptionId = id;
        currentTranscriptionText = text;
        currentTranscriptionTitle = title;
        currentTranscriptionCategory = category;
        
        // Configurar título e texto
        document.getElementById('modal-transcription-title').textContent = title;
        document.getElementById('transcription-text').textContent = text;
        
        // Configurar formulário de edição
        document.getElementById('edit-title').value = title;
        
        // Limpar status
        document.getElementById('update-status').textContent = '';
        document.getElementById('update-status').className = 'update-status';
        
        // Ativar a primeira tab (conteúdo)
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelector('.modal-tab[data-tab="content"]').classList.add('active');
        document.getElementById('tab-content').classList.add('active');
        
        // Mostrar o modal
        document.getElementById('transcription-modal').classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevenir rolagem
    }
    
    function closeModal() {
        document.getElementById('transcription-modal').classList.remove('active');
        document.body.style.overflow = ''; // Restaurar rolagem
    }
    
    // Manipulação de tabs do modal
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remover classe ativa de todas as tabs
            document.querySelectorAll('.modal-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Adicionar classe ativa na tab clicada
            this.classList.add('active');
            
            // Mostrar conteúdo da tab
            const tabName = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Se for a tab de categorias, carregar as categorias
            if (tabName === 'categories') {
                // Aqui você pode implementar a lógica para carregar categorias
                // loadCategories();
            }
        });
    });
    
    // Formulário de edição
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        updateTranscription();
    });
    
    function updateTranscription() {
        const title = document.getElementById('edit-title').value.trim();
        const statusElement = document.getElementById('update-status');
        
        if (!title) {
            statusElement.textContent = 'O título não pode estar vazio';
            statusElement.className = 'update-status error';
            return;
        }
        
        const data = {
            title: title
        };
        
        fetch(`/transcription/${currentTranscriptionId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusElement.textContent = 'Transcrição atualizada com sucesso!';
                statusElement.className = 'update-status success';
                
                // Atualizar valores atuais
                currentTranscriptionTitle = title;
                
                // Atualizar título no modal
                document.getElementById('modal-transcription-title').textContent = title;
                
                // Atualizar a UI após 1 segundo
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.error || 'Erro ao atualizar transcrição');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            statusElement.textContent = error.message || 'Ocorreu um erro. Tente novamente.';
            statusElement.className = 'update-status error';
        });
    }
    
    // Função para baixar a transcrição como PDF
    function downloadTranscriptionPDF(id) {
        if (!id) return;
        
        fetch(`/transcription/${id}/download?format=pdf`)
            .then(response => {
                if (!response.ok) throw new Error('Erro ao baixar PDF');
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentTranscriptionTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Não foi possível baixar o PDF. Tente novamente.');
            });
    }
    
    // Função para baixar a transcrição como TXT
    function downloadCurrentText() {
        if (!currentTranscriptionText) return;
        
        const blob = new Blob([currentTranscriptionText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentTranscriptionTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Função para baixar transcrição do servidor
    function downloadTranscription(id, title) {
        fetch(`/transcription/${id}/download`)
            .then(response => {
                if (!response.ok) throw new Error('Erro ao baixar transcrição');
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Não foi possível baixar a transcrição. Tente novamente.');
            });
    }
    
    // Funções para o modal de exclusão
    function confirmDelete(id, title) {
        currentTranscriptionId = id;
        isPDF = false;
        document.getElementById('delete-message').textContent = 
            `Tem certeza que deseja excluir a transcrição "${title}"? Esta ação não pode ser desfeita.`;
        
        const deleteBtn = document.getElementById('confirm-delete-btn');
        deleteBtn.onclick = deleteTranscription;
        
        document.getElementById('delete-modal').classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevenir rolagem
    }
    
    function confirmDeletePDF(filename) {
        currentTranscriptionId = filename;
        isPDF = true;
        document.getElementById('delete-message').textContent = 
            `Tem certeza que deseja excluir o PDF "${filename}"? Esta ação não pode ser desfeita.`;
        
        const deleteBtn = document.getElementById('confirm-delete-btn');
        deleteBtn.onclick = deletePDF;
        
        document.getElementById('delete-modal').classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevenir rolagem
    }
    
    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.remove('active');
        document.body.style.overflow = ''; // Restaurar rolagem
    }
    
    function deleteTranscription() {
        if (!currentTranscriptionId) return;
        
        fetch(`/transcription/${currentTranscriptionId}/delete`, {
            method: 'DELETE',
        })
        .then(response => {
            if (!response.ok) throw new Error('Erro ao excluir transcrição');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Redirecionar para atualizar a página
                window.location.reload();
            } else {
                throw new Error(data.error || 'Erro ao excluir transcrição');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Não foi possível excluir a transcrição. Tente novamente.');
            closeDeleteModal();
        });
    }
    
    function deletePDF() {
        if (!currentTranscriptionId) return;
        
        fetch(`/delete_pdf/${currentTranscriptionId}`, {
            method: 'POST',
        })
        .then(response => {
            if (!response.ok) throw new Error('Erro ao excluir PDF');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Redirecionar para atualizar a página
                window.location.reload();
            } else {
                throw new Error(data.error || 'Erro ao excluir PDF');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Não foi possível excluir o PDF. Tente novamente.');
            closeDeleteModal();
        });
    }
    
    // Fechar modal ao clicar fora dele
    window.onclick = function(event) {
        const transcriptionModal = document.getElementById('transcription-modal');
        const deleteModal = document.getElementById('delete-modal');
        
        if (event.target === transcriptionModal) {
            closeModal();
        }
        
        if (event.target === deleteModal) {
            closeDeleteModal();
        }
    };
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
            closeDeleteModal();
        }
    });
</script>
{% endblock %} 